#!/bin/bash
#ddev-generated
## Description: Install Playwright browsers and system dependencies
## Usage: install-playwright
## Example: "ddev install-playwright"

set -e

echo "Installing Playwright browsers and dependencies..."

# Check if browsers are already installed
if [ -f /opt/playwright-browsers/.installed ]; then
    echo "✓ Playwright browsers are already installed at /opt/playwright-browsers"
else
    echo "Installing Playwright browsers..."

    # Ensure Node.js is available
    if ! command -v node &> /dev/null; then
        echo "Node.js not found. Attempting to use nvm..."
        if command -v nvm &> /dev/null; then
            nvm install 22
            nvm use 22
        elif [ -f ~/.nvm/nvm.sh ]; then
            source ~/.nvm/nvm.sh
            nvm install 22
            nvm use 22
        else
            echo "⚠️  nvm not available. Using system Node.js if available."
            if ! command -v node &> /dev/null; then
                echo "❌ Node.js is required but not found. Please install Node.js 22."
                exit 1
            fi
        fi
    fi

    # Install Playwright locally in the project if not already installed
    cd /var/www/html/tests/Playwright
    if [ ! -f package.json ]; then
        echo "Initializing Playwright project first..."
        # Try to use Node.js 22 via nvm if available
        if command -v nvm &> /dev/null; then
            nvm use 22 2>/dev/null || true
        elif [ -f ~/.nvm/nvm.sh ]; then
            source ~/.nvm/nvm.sh
            nvm use 22 2>/dev/null || true
        fi
        echo 'n' | npm init playwright@latest -- --quiet --lang=TypeScript --no-browsers || {
          echo 'Playwright init failed, trying alternative approach...'
          npm init -y
          npm install @playwright/test@latest
          npx playwright init --yes --lang=TypeScript --no-browsers
        }
    else
        # Install Playwright dependencies
        echo "Installing Playwright dependencies..."
        npm install @playwright/test@latest
    fi

    # Install browsers to the persistent location
    echo "Downloading browser binaries..."
    npx playwright install chromium firefox webkit

    # Mark as installed
    touch /opt/playwright-browsers/.installed

    echo "✓ Playwright browsers installed successfully!"
fi

# Verify installation
echo ""
echo "Verifying Playwright installation..."
cd /var/www/html/tests/Playwright
if [ -f package.json ]; then
    # Ensure we're using the correct Node.js version
    if command -v nvm &> /dev/null; then
        nvm use 22 2>/dev/null || true
    elif [ -f ~/.nvm/nvm.sh ]; then
        source ~/.nvm/nvm.sh
        nvm use 22 2>/dev/null || true
    fi
    # Check if Playwright is installed in the project
    if [ -d "node_modules/@playwright" ]; then
        npx playwright --version
        echo ""
        echo "Installed browsers:"
        npx playwright install --list
    else
        echo "⚠️  Playwright not installed in project. Installing dependencies..."
        npm install @playwright/test@latest
        npx playwright --version
        echo ""
        echo "Installed browsers:"
        npx playwright install --list
    fi
else
    echo "⚠️  Playwright project not found. Please run 'ddev playwright' first to initialize the project."
fi

echo ""
echo "✓ Playwright is ready to use!"
echo ""
echo "Next steps:"
echo "  1. Run tests: ddev playwright test"
echo "  2. Generate code: ddev playwright codegen"
echo "  3. View report: ddev playwright show-report --host=0.0.0.0"
